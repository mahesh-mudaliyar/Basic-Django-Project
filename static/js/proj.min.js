var tblLoad='<table id="tblData" align="center"> <tbody> <tr> <td><input type="button" onclick="addSchedule();" style="width:100%;" id="btnadd" value="Add"></td> </tr> <tr> <td><b>MONDAY</b></td> </tr> <tr> <td><b>TUESDAY</b></td> </tr> <tr> <td><b>WEDNESDAY</b></td> </tr> <tr> <td><b>THURSDAY</b></td> </tr> <tr> <td><b>FRIDAY</b></td> </tr> <tr> <td><b>SATURDAY</b></td> </tr> <tr> <td></td> </tr> </tbody> </table>';
function accrtlink() {
  if ($(".register-form").is(":hidden")) {
    $(".login-form").hide();
    $(".register-form").show();
  } else {
    $(".login-form").show();
    $(".register-form").hide();
  }
}

function chkusrname() {
  $.ajax({
    url: '/chkusrname/',
    type: 'GET',
    data: {
      "rusername": $("#rusername").val()
    },
    success: function (response) {
      if (response.success) {
        $("#rusername").removeClass("is-invalid");
        $(".fail-rusername").hide();
        $("#rusername").addClass("is-valid");
      } else {
        $("#rusername").removeClass("is-valid");
        $(".fail-rusername").show();
        $("#rusername").addClass("is-invalid");
      }
    },
  });
}
function chkpass() {
  if ($("#rpassword").val() != $("#confpassword").val()) {
    $("#confpassword").addClass("is-invalid");
  } else {
    $("#confpassword").removeClass("is-invalid");
  }
}
$('#registerForm').submit(function (e) {
  e.preventDefault();
  $form = $(this)
  var formData = new FormData(this);
  if ($("#rpassword").val() == $("#confpassword").val()) {
    $.ajax({
      url: '/registerForm/',
      type: 'POST',
      data: formData,
      success: function (response) {
        if (response.success) {
          swal("Successful", "", "success");
          accrtlink()
        } else {
          swal({
            title: "Error",
            text: response.reason,
            icon: "warning",
            buttons: false,
            dangerMode: true,
          })
        }
      },
      cache: false,
      contentType: false,
      processData: false
    });
  } else {
    $("#confpassword").addClass("is-invalid");
  }
})
$('#loginForm').submit(function (e) {
  e.preventDefault();
  $form = $(this)
  var formData = new FormData(this);
  $.ajax({
    url: '/loginForm/',
    type: 'POST',
    data: formData,
    success: function (response) {
      if (response.success) {
        $(".fail-login").hide();
        if ($("#chkrember").prop("checked") == true) {
          sessionStorage.setItem("username", $("#username").val());
          sessionStorage.setItem("password", $("#password").val());
        }
        window.location.href = "/success/";
      } else {
        $(".fail-login").show();
      }
    },
    cache: false,
    contentType: false,
    processData: false
  });
})
var myform = $("#tblData"), iter = 0;
function ajaxdrop(date){
  $.ajax({
    url: '/ajax-dropdown/',
    type: 'GET',
    data: {
      "rusername": "a",
      "date":date
    },
    success: function (response) {
      $(".ajax-dropdown").html(response);
      $('.select2').select2();
    },
  });
}
function addSchedule() {
  var tcol = 1;
  myform.find('tr').each(function () {
    var trow = $(this);
    if (trow.index() === 0) {
      trow.append('<td><input type="time" placeholder="Time(HH:MM)"/> - <input type="time" placeholder="Time(HH:MM)"/></td>');
    } else if (trow.index() === 7) {
      trow.append('<td><input class="row-delete btn btn-danger" type="button" value="Delete"  style="width:100%;"></td>');
    } else {
      trow.append('<td onclick="togglecls(this);"><input style="width:100%;" type="text" name="tb_row_' + iter + '%col_' + tcol + '" id="tb_row_' + iter + '%col_' + tcol + '"/></td>');
    }
    tcol += 1;
  });
  iter += 1;
  $("#saveTbl").show();
  $("#delTbl").show();
  $("#mergeTbl").show();
  $("#editTbl").hide();
  $("#printTbl").hide();
  $("#canceleditTbl").show();
}
$("#editTbl").click(function () {
  $('.txtbox').each(function () {
    txtval = $(this).html();
    $(this).replaceWith('<input type="text" value="' + txtval + '" />');
  })
  $('.datebox').each(function () {
    txtval = $(this).html();
    $(this).replaceWith('<input type="time" style="width:100%;" value="' + txtval + '" />');
  })
  $("#saveTbl").hide();
  $("#updateTbl").show();
  $("#mergeTbl").show();
  $("#delTbl").show();
  $('#editTbl').hide();
  $("#printTbl").hide();
  $('#canceleditTbl').show();
})

$('#tblform').submit(function (e) {
  $('input[type=text]').each(function () {
    txtval = $(this).val()
    $(this).replaceWith("<div class='txtbox'>" + txtval + "</div>")
  });
  $('input[type=time]').each(function () {
    txtval = $(this).val()
    $(this).replaceWith("<div class='datebox'>" + txtval + "</div>")
  });
  e.preventDefault();
  $("td").removeClass("selected");
  var TableData = $("#tblData").html();
  $.ajax({
    url: '/savedata/',
    type: 'POST',
    data: {
      'tabledata': TableData,
    },
    success: function (response) {
      if (response.success) {
        swal("Successful", "", "success");
        ajaxdrop(response.date)
      } else {
        swal({
          title: "Error",
          text: response.reason,
          icon: "warning",
          buttons: false,
          dangerMode: true,
        })
      }
    }
  });
  $("#saveTbl").hide();
  $('#mergeTbl').hide();
  $("#delTbl").show();
  $('#editTbl').show();
  $('#delTbl').show();
  $('#printTbl').show();
  $("#canceleditTbl").hide();
})

$('#printTbl').click(function () {
  $('#btnadd').hide();
  $('.row-delete ').hide();
  $('#mergeTbl').hide();
  $('#editTbl').hide();
  $('#delTbl').hide();
  $('#printTbl').hide();
  var pageTitle = 'Schedule', stylesheet = '/static/css/proj.min.css',
    win = window.open('', 'Print', 'width=auto,height=auto');
  var mystyle = "table, tr, td{ border:1px solid black; border-collapse: separate; border-spacing: 5px; } td{ padding:1px 4px; }";
  win.document.write('<html><head><title>' + pageTitle + '</title>' +
    '<link rel="stylesheet" href="' + stylesheet + '"> <style>' + mystyle + '</style>' +
    '</head><body>' + $('#grid_configurator')[0].outerHTML + '</body></html>');
  win.document.close();
  win.print();
  win.close();
  $('#btnadd').show();
  $('.row-delete ').show();
  $('#mergeTbl').hide();
  $('#editTbl').show();
  $('#delTbl').show();
  $('#printTbl').show();
  return false;
})

function togglecls(a) {
  $(a).toggleClass("selected");
}
function table_merger(table_id, merge_cell_class) {
  this.cell_class = merge_cell_class === undefined ? 'selected' : merge_cell_class;
  if (table_id === undefined)
    console.error("bad input");
  else
    this.table_id = table_id;
  merge(this.table_id, this.cell_class);
  function merge(table_id, cell_class) {
    var table_div = table_id;
    var hasMerged = true;
    while (hasMerged) {
      hasMerged = false;
      if ($(table_div).find("." + cell_class).length < 2)
        return;
      var table_rows = $(table_div).find("tr");
      for (var i = 0; i < table_rows.length; i++) {
        var selected_cells_row = $(table_rows[i]).find("." + cell_class);
        if (selected_cells_row.length < 2)
          continue;
        for (var j = 0; j < selected_cells_row.length; j++) {
          if (j >= selected_cells_row.length - 1)
            break;
          var current_cell = selected_cells_row[j];
          var next_cell = selected_cells_row[j + 1];
          if (current_cell.cellIndex + current_cell.colSpan !== next_cell.cellIndex)
            continue;
          if (current_cell.rowSpan !== next_cell.rowSpan)
            continue;
          $(current_cell).attr('colSpan', current_cell.colSpan + next_cell.colSpan);
          $(next_cell).removeClass(cell_class);
          $(next_cell).addClass('hidden');
          hasMerged = true;
          selected_cells_row = $(table_rows[i]).find("." + cell_class);
        }
      }
      var selected_cells = $(table_div).find("." + cell_class);
      if (selected_cells.length < 2)
        return;
      for (var i = 0; i < selected_cells.length; i++) {
        if (i >= selected_cells.length - 1)
          break;
        var current_cell = selected_cells[i];
        var cells = $(current_cell.parentElement).nextAll()[current_cell.rowSpan - 1];
        if (!cells)
          continue;
        var next_cell = cells.children[current_cell.cellIndex];
        if (!next_cell)
          continue;
        if (!$(next_cell).hasClass(cell_class))
          continue;
        if (current_cell.colSpan !== next_cell.colSpan)
          continue;
        $(current_cell).attr('rowSpan', current_cell.rowSpan + next_cell.rowSpan);
        $(next_cell).removeClass(cell_class);
        $(next_cell).addClass('hidden');
        hasMerged = true;
        selected_cells = $(table_div).find("." + cell_class);
      }
    }
  }
}

$(function () {
  ajaxdrop();
  
})

$('#mergeTbl').click(function () {
  if ($("#tblData").find(".selected").length >= 2) {
    swal({
      title: "Are you sure?",
      text: "Once Merged, you cannot undo!\nNote: Record in the selected cells may be deleted.",
      icon: "warning",
      buttons: true,
      dangerMode: true,
    })
      .then((willDelete) => {
        if (willDelete) {
          table_merger('#grid_configurator')
          $("td").removeClass("selected");
          var TableData = $("#tblData").html();
          cookie('TableData', TableData, '')
        } else {
          swal("Your records are safe!");
          return false;
        }
      });
  } else {
    swal({
      text: "PLease select cells.",
      dangerMode: true,
    })
  }
})

$("table").on("click", ".row-delete", function ( event ) {
  if($("#tblData").find("tr:first td").length>2){
    swal({
      title: "Are you sure?",
      text: "Once Deleted, you cannot undo!",
      icon: "warning",
      buttons: true,
      dangerMode: true,
    })
    .then((willDelete) => {
      if (willDelete) {
        var ndx = $(this).parent().index() + 1;
        $("td", event.delegateTarget).remove(":nth-child(" + ndx + ")");
        $("#updateTbl").show();
        $('#canceleditTbl').show();      
        swal("Done", "", "success");
      } else {
        swal("Your records are safe!");
          return false;
      }
    });
  }else{
    $('#delTbl').click()
  }
})
$("#delTbl").click(function(){
  var selval = $(".select2").val();
  swal({
    title: "Are you sure?",
    text: "Once Deleted, you will not be able to view!",
    icon: "warning",
    buttons: true,
    dangerMode: true,
  })
  .then((willDelete) => {
    if (willDelete) {
      $.ajax({
        url: '/deldata/',
        type: 'POST',
        data: {
          'date': selval,
        },
        success: function (response) {
          if (response.success) {            
            $('#tblData').html(tblLoad);
            swal("Successful", "", "success");
            ajaxdrop();
          } else {
            swal({
              title: "Error",
              text: response.reason,
              icon: "warning",
              buttons: false,
              dangerMode: true,
            })
          }
        }
      });
      $("#saveTbl").hide();
      $('#mergeTbl').hide();
      $('#editTbl').hide();
      $('#delTbl').hide();
      $('#printTbl').hide();
      $('#updateTbl').hide();
      $('#canceleditTbl').hide();
    } else {
      swal("Your records are safe!");
       return false;
    }
  });
})

function selectload(){
  var selval = $(".select2").val();
  if ($(".select2").val() != "") {
    $.ajax({
        url: '/loadata/',
        type: 'get',
        data: {
            'selectval': (selval || ""),
        },
        success: function (response) {
            if (response.success) {
                $('#tblData').html(response.data);
                $("#mergeTbl").hide();
                $("#saveTbl").hide();
                $("#updateTbl").hide();
                $("#editTbl").show();
                $("#delTbl").show();
                $("#printTbl").show();
                $(".select2").val(selval);
            } else {
                swal({
                    text: "Something went wrong!!!!",
                    dangerMode: true,
                })
            }
        }
    });
  }
}

$("#updateTbl").click(function (e) {
  e.preventDefault();
  $('input[type=text]').each(function () {
    txtval = $(this).val()
    $(this).replaceWith("<div class='txtbox'>" + txtval + "</div>")
  });
  $('input[type=time]').each(function () {
    txtval = $(this).val()
    $(this).replaceWith("<div class='datebox'>" + txtval + "</div>")
  });
  $("td").removeClass("selected");
  var TableData = $("#tblData").html();
  var selval = $(".select2").val();
  $.ajax({
    url: '/savedata/',
    type: 'POST',
    data: {
      'tabledata': TableData,
      'update': "update",
      'date': selval,
    },
    success: function (response) {
      if (response.success) {
        swal("Successful", "", "success");
        ajaxdrop(response.date)
      } else {
        swal({
          title: "Error",
          text: response.reason,
          icon: "warning",
          buttons: false,
          dangerMode: true,
        })
      }
    }
  });
  $("#saveTbl").hide();
  $('#mergeTbl').hide();
  $('#editTbl').show();
  $('#delTbl').show();
  $('#printTbl').show();
  $('#updateTbl').hide();
  $("#canceleditTbl").hide();
})
$('#canceleditTbl').click(function () {
  selectload()
})
